{% extends "Dashboard/base.html" %}
{% load static %}


{% block css %}
<link href="{% static 'Css/searchbar.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_meta %}
{% endblock %}

{% block title %}
    Files
{% endblock %}

{% block content %}


                        <!-- content -->
        <div class="container-fluid row p-2">
            <div class="container-fluid row p-2"></div>

            <div class="col d-flex pb-1 justify-content-start">
            <form action="{% url 'search_files' %}" method="get">
                <input
                class="form-control me-2"
                name='q'
                id="searchFiles"
                type="search"
                placeholder="Search"
                aria-label="Search"
              />
            </form>

            </div>   


            <div class="col text-end">
                <button class=" btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">Upload File</button>                
            </div>   

<!-- Separator -->
<hr class="my-4">
<!-- Show number of Entries -->
<div class="container-fluid">
    <div class="d-flex justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <label for="entriesSelect" class="form-label me-2 mb-0">Show</label>
            <select class="form-select form-select-sm me-2" id="entriesSelect" style="width: 100px;">
                <option value="all">All</option>
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="30">30</option>
                <option value="35">35</option>
                <option value="40">40</option>
                <option value="45">45</option>
                <option value="50">50</option>
                <!-- Add more options if needed -->
            </select>
            <span class="me-2">entries</span>
        </div>

        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                var entriesSelect = document.getElementById("entriesSelect");
                entriesSelect.addEventListener("change", function() {
                    var selectedValue = entriesSelect.value;
                    updateTableEntries(selectedValue);
                });
            });
        
            function updateTableEntries(entries) {
                var tableRows = document.querySelectorAll('#filesTable tbody tr');
        
                tableRows.forEach(function(row, index) {
                    if (entries === 'all' || index < parseInt(entries)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });  
            }
        </script>



<!-- JavaScript -->
<script>
    // Get reference to the select element
    var typeSortSelect = document.getElementById('typeSort');

    // Add event listener to the select element
    typeSortSelect.addEventListener('change', function() {
        filterByFileType(this.value);
    });

    // Function to filter files by file type
    function filterByFileType(fileType) {
        var files = document.querySelectorAll('#filesTable tbody tr');
        files.forEach(function(file) {
            var fileNameElement = file.querySelector('td:first-child a');
            var fileName = fileNameElement ? fileNameElement.textContent : ''; // Get file name
            var fileExtension = fileName.split('.').pop().toLowerCase(); // Extract file extension
            if (fileType === 'all' || fileType === fileExtension) {
                file.style.display = 'table-row'; // Show file
            } else {
                file.style.display = 'none'; // Hide file
            }
        });
    }
</script>







            <!-- modal for upload files -->
            <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadFileModalLabel">Upload File
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadFileForm" method="POST" action="{% url 'upload_file' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="fileName" class="form-label">File Name</label>
                                <input type="text" class="form-control" id="fileName" name="fileName" placeholder="Enter file name">
                            </div>
                            <div class="mb-3">
                                <label for="fileDescription" class="form-label">File Description</label>
                                <input type="text" class="form-control" id="fileDescription" name="fileDescription" placeholder="Enter file description">
                            </div>
                            <div class="mb-3">
                                <label for="file" class="form-label">Select File</label>
                                <input type="file" class="form-control" id="file" name="file" aria-describedby="fileHelp">
                                <small id="fileHelp" class="form-text text-muted">Supported file types: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, JPEG</small>
                            </div>
                        <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <!-- <div id="uploadProgress" class="mt-3 text-center" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Uploading...</span>
                        </div>
                        </div>
                        <div id="uploadMessage" class="mt-3"></div> -->
                    </div>
                    </div>
                    </div>
                </div>


                
<!-- Rename File Modal -->
<div class="modal fade" id="renameFileModal" tabindex="-1" aria-labelledby="renameFileModalLabel"
aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="renameFileModalLabel">Rename Filexx</h5>
              
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="renameFileForm" method="POST" action="{% url 'rename_file' %}">
                {% csrf_token %}
                <div class="mb-3">
                      <label for="newFileNameInput" class="form-label">New File Name</label>
                      <input type="text" class="form-control" id="newFileNameInput" name="newFileName" placeholder="Enter new file name" required>
                      <div class="invalid-feedback">Please enter a new file name.</div>
                  </div>
                      <!-- Hidden input for storing the file ID -->
                <input type="hidden" id="renameFileId" name="fileID">
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" form="renameFileForm" class="btn btn-primary">Rename</button>
              
          </div>
      </div>
  </div>
</div>




                    <!-- Download File Confirmation Modal -->
                    <div class="modal fade" id="downloadFileModal" tabindex="-1"
                        aria-labelledby="downloadFileModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="downloadFileModalLabel">Download File</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to download this file?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="handleDownload()">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              
<!-- Files Table -->                
<div class="container-fluid">
    <table id="filesTable" class="table">
        <thead class="border-top border-bottom">
            <tr>
                <th scope="col">
                    Date Uploaded 
                    <button class="btn btn-sm me-2" onclick="toggleDropdown('dateUploaded')">
                        <i class="bi bi-filter"></i>
                    </button>
                    <!-- DateUploaded filter dropdown -->
                    <div id="dateUploadedDropdown" class="dropdown-menu" style="display: none;">
                        <a class="dropdown-item" href="#" onclick="filterByDateUploaded('all')">All</a>
                        <a class="dropdown-item" href="#" onclick="filterByDateUploaded('ascending')">Ascending</a>
                        <a class="dropdown-item" href="#" onclick="filterByDateUploaded('descending')">Descending</a>
                    </div>
                </th>
                <th scope="col">
                    File Name
                    <button class="btn btn-sm me-2" onclick="toggleDropdown('fileName')">
                        <i class="bi bi-filter"></i>
                    </button>
                    <!-- FileName filter dropdown -->
                    <div id="fileNameDropdown" class="dropdown-menu" style="display: none;">
                        <a class="dropdown-item" href="#" onclick="filterByFileName('all')">All</a>
                        <a class="dropdown-item" href="#" onclick="filterByFileName('ascending')">Ascending</a>
                        <a class="dropdown-item" href="#" onclick="filterByFileName('descending')">Descending</a>
                    </div>
                </th>
                
                <th scope="col">Details</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table content -->
            {% for file in files %}
            <tr>
                
                    <td>{{ file.uploaded_at|date:"Y-m-d" }}</td>
                <td>
                    <a href="{% url 'serve_file' file_id=file.fileID %}" target="_blank">{{ file.fileName }}</a>
                </td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle" type="button" id="dropdownMenuButton{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ forloop.counter }}">
                            <li><a class="dropdown-item" href="#" data-file-id="{{ file.fileID }}" data-bs-toggle="modal" data-bs-target="#detailsModal">Details</a></li>
                            <li><a class="dropdown-item" href="{% if file.file %}{{ file.file.url }}{% endif %}">Download</a></li>
                            <li><a class="dropdown-item" href="#" data-file-id="{{ file.fileID }}" data-bs-toggle="modal" data-bs-target="#renameFileModal">Rename</a></li>
                            <li><a class="dropdown-item text-danger" data-file-id="{{ file.fileID }}" data-bs-toggle="modal" data-bs-target="#deleteFileModal">Delete</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Dropdown Functions -->
<script>
    function toggleDropdown(dropdownId) {
        var dropdown = document.getElementById(dropdownId + 'Dropdown');
        var dropdownStyle = window.getComputedStyle(dropdown);
        if (dropdownStyle.display === 'none') {
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }
  
    function closeDropdown(dropdownId) {
        var dropdown = document.getElementById(dropdownId + 'Dropdown');
        dropdown.style.display = 'none';
    }
  
    function filterByFileName(order) {
        var rows = document.querySelectorAll('#filesTable tbody tr');
        var sortedRows = Array.from(rows).sort(function(a, b) {
            var fileNameA = a.querySelector('td:nth-child(2) a').textContent.toLowerCase();
            var fileNameB = b.querySelector('td:nth-child(2) a').textContent.toLowerCase();
            if (order === 'ascending') {
                return fileNameA.localeCompare(fileNameB);
            } else if (order === 'descending') {
                return fileNameB.localeCompare(fileNameA);
            } else {
                // No sorting
                return 0;
            }
        });
  
        var tbody = document.querySelector('#filesTable tbody');
        tbody.innerHTML = ''; // Clear existing rows
        sortedRows.forEach(function(row) {
            tbody.appendChild(row);
        });
  
        closeDropdown('fileName');
    }
  
    function filterByDateUploaded(order) {
        var rows = document.querySelectorAll('#filesTable tbody tr');
        var sortedRows = Array.from(rows).sort(function(a, b) {
            var dateUploadedA = new Date(a.querySelector('td:first-child').textContent);
            var dateUploadedB = new Date(b.querySelector('td:first-child').textContent);
  
            if (order === 'ascending') {
                return dateUploadedA - dateUploadedB;
            } else if (order === 'descending') {
                return dateUploadedB - dateUploadedA;
            } else {
                // No sorting
                return 0;
            }
        });
  
        var tbody = document.querySelector('#filesTable tbody');
        tbody.innerHTML = ''; // Clear existing rows
        sortedRows.forEach(function(row) {
            tbody.appendChild(row);
        });
  
        closeDropdown('dateUploaded');
    }
</script>





                    <!-- Delete File Confirmation Modal -->
                    <div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{% url 'delete_files' %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteFileModalLabel">Delete File</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p id="deleteConfirmationText">Are you sure you want to delete this file?</p>
                                        <!-- Hidden input for the file ID -->
                                        <input type="hidden" name="file_ids" id="deleteFileId" value="">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>


<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>File Name:</strong> <span id="modalFileName"></span></p>
                <p><strong>File Type:</strong> <span id="modalFileType"></span></p>
                <p><strong>File Size:</strong> <span id="modalFileSize"></span></p>
                <p><strong>Date Uploaded:</strong> <span id="modalDateUploaded"></span></p>
            </div>
            <div class="modal-footer">
                <button id="openFileButton" type="button" class="btn btn-primary" onclick="openFile()">Open File</button>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>



        <footer class="d-flex justify-content-between p-3 bg-light ">
            <button class="btn btn-primary" id="previous-page">Previous</button>
            <span class="mx-3">Page <span id="current-page">1</span> of <span id="total-pages">10</span></span>
            <button class="btn btn-primary" id="next-page">Next</button>
        </footer>
    </div>
</div>
</div>

{% endblock %} 

{% block js %}

<script src="{% static 'Js/uploadfile.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var uploadForm = document.getElementById('uploadFileForm');
        uploadForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the normal form submission
    
            var formData = new FormData(uploadForm);
            var xhr = new XMLHttpRequest();
            // Use window.location to build the URL dynamically
            xhr.open('POST', `${window.location.origin}/orphans/upload_file/`, true);
    
            // Set up what happens when the request comes back
            xhr.onload = function () {
                // document.getElementById('uploadProgress').style.display = 'none'; // Hide progress
                if (xhr.status === 200) {
                    alert('File uploaded successfully.');
                    $('#uploadFileModal').modal('hide'); // Close the modal
                    window.location.reload(); // Reload the page
                } else if (xhr.status === 400) {
                    alert('No file uploaded.');
                } else if (xhr.status === 405) {
                    alert('Invalid request method.');
                } else {
                    alert('Server error. Please try again later.');
                }
            };
    
            // Show uploading progress
            // document.getElementById('uploadProgress').style.display = 'block';
    
            // Send the actual request
            xhr.send(formData);
        });
    });
    </script>
    
    

<script>
$('#searchFiles').autocomplete({
    source: function(request, response) {
        $.ajax({
            url: "{% url 'search_files' %}",  // Ensure this URL is correctly pointing to your search view.
            dataType: 'json',
            data: {
                'q': request.term
            },
            success: function(data) {
                response($.map(data, function(item) {
                    return {
                        label: item.label,
                        value: item.value  // Ensure this correctly references the ID.
                    };
                }));
            }
        });
    },
    minLength: 1,
    select: function(event, ui) {
        event.preventDefault(); // Prevent default action

        // Utilize the AJAX logic you have for the dropdown, adapted for the autocomplete selection
        $.ajax({
            url: '/orphans/files/details/' + ui.item.value + '/',  // Adapted for consistency with your provided AJAX setup
            type: 'GET',
            success: function(data) {
                // Populate the modal with the returned data
                $('#modalFileName').text(data.fileName);
                $('#modalFileType').text(data.fileType);
                $('#modalFileSize').text(data.fileSize + ' bytes'); // Ensure you add any necessary text or formatting
                $('#modalDateUploaded').text(data.dateUploaded);
                $('#openFileButton').data('file-url', '/orphans/files/serve/' + ui.item.value + '/');

                // Show the modal
                $('#detailsModal').modal('show');
            },
            error: function(xhr, status, error) {
                console.log("Error fetching file details: ", error);
            }
        });
    }
});

// Function to open the file when the "Open File" button is clicked
function openFile() {
    var fileUrl = $('#openFileButton').data('file-url');
    if (fileUrl) {
        window.open(fileUrl, '_blank');
    } else {
        console.error('File URL is not defined.');
    }
}

</script>

<script>
    $(document).ready(function() {
        // When the delete button is clicked
        $('.dropdown-item.text-danger').click(function() {
            // Get the file ID from the data attribute
            var fileId = $(this).data('file-id');
            // Set the file ID in the hidden input field
            $('#deleteFileId').val(fileId);
        });
    });
</script>

<script>

// Using jQuery, ensure this script runs after the page has fully loaded
$(document).ready(function() {
    // Event listener for your rename link/button
    $('a[data-bs-toggle="modal"]').on('click', function() {
        var fileId = $(this).data('file-id'); // Retrieve the file ID
        console.log("File ID:", fileId); // Debugging: log the file ID to ensure it's captured
        $('#renameFileId').val(fileId); // Assign the file ID to the hidden input
    });
});

</script>
{% endblock %}