
def intervention_academics(request):
    # Define a dictionary to map intervention statuses to colors
    intervention_status_colors = {
        'unresolved': 'danger',  # Red color for unresolved issues
        'pending': 'warning',  # Yellow color for pending issues
        'resolved': 'success',  # Green color for resolved issues
        None: 'info'  # Blue color for no intervention needed
    }
    print("Dictionary keys:", intervention_status_colors.keys())

    # Fetch all orphans and their latest intervention data
    orphans = Info.objects.prefetch_related(
        'educations__grades', 'academicinterventions').all()
    orphan_educations_status = []

    for orphan in orphans:
        # Order by 'last_modified' to get the latest academic intervention
        latest_intervention = orphan.academicinterventions.order_by(
            '-last_modified').first()
        critical_needed = any(grade.grade < 70 for education in orphan.educations.all(
        ) for grade in education.grades.all())
        significant_needed = any(70 <= grade.grade < 75 for education in orphan.educations.all(
        ) for grade in education.grades.all())

        # Setup intervention status based on latest data or defaults
        if latest_intervention:
            intervention_status = latest_intervention.status
            intervention_color = intervention_status_colors.get(
                intervention_status, 'info')
            remarks = latest_intervention.description
            last_modified = latest_intervention.last_modified
        else:
            # Default values if no intervention exists
            intervention_status = 'unresolved' if critical_needed or significant_needed else None
            intervention_color = intervention_status_colors.get(
                intervention_status, 'info')
            remarks = ''
            last_modified = None

        # Determine the academic status based on intervention needs
        if critical_needed:
            status = 'Critical Improvement Needed'
        elif significant_needed:
            status = 'Needs Significant Improvement'
        else:
            status = 'Meets Expectations'

        # Assuming same color logic for both for simplicity
        status_color = intervention_color

        # Collect data for rendering
        orphan_educations_status.append({
            'orphan': orphan,
            'status': status,
            'status_color': status_color,
            'intervention_status': intervention_status,
            'intervention_color': intervention_color,
            'last_modified': last_modified,
            'remarks': remarks,
        })
        print(f"Final Status: {intervention_status}, Final Color: {
              intervention_color}")

    # Define sort_key function for sorting based on priority

    def sort_key(item):
        # Define priority mapping
        priority_mapping = {
            'Critical Improvement Needed': 1,
            'Needs Significant Improvement': 2,
            'Meets Expectations': 3
        }
        # Resolve to a large number if status is unknown to ensure they appear at the end
        status_priority = priority_mapping.get(item['status'], 99)

        # Secondary sort by intervention status if needed
        intervention_priority_mapping = {
            'unresolved': 1,
            'pending': 2,
            'resolved': 3,
            None: 4
        }
        intervention_priority = intervention_priority_mapping.get(
            item['intervention_status'], 99)

        return (status_priority, intervention_priority)

    # Sorting the list of orphans based on the defined sort key
    orphan_educations_status.sort(key=sort_key)

    context = {
        'orphan_educations_status': orphan_educations_status,
        'orphan_ids': [orphan.orphanID for orphan in Info.objects.all()],
        'orphan_count': Info.objects.count(),
    }
    print(f"Before mapping: status={intervention_status}, available_keys={
          list(intervention_status_colors.keys())}")

    return render(request, 'Dashboard/intervention_academics.html', context)