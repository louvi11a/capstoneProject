
def intervention_health(request):
    current_year = now().year
    current_month = now().month

    health_status_colors = {
        'Optimal Health': 'success',
        'Good Health': 'warning',
        'Marginal Health': 'primary',
        'Poor Health': 'danger',
    }

    intervention_status_colors = {
        'unresolved': 'danger',
        'pending': 'warning',
        'resolved': 'success',
        'none': 'info'  # Updated to use 'none' instead of None
    }

    orphans_with_health = []
    orphans = Info.objects.all()
    for orphan in orphans:
        monthly_health_score = HealthDetail.calculate_monthly_health_score(
            orphan, current_month, current_year)
        latest_intervention = orphan.healthinterventions.order_by(
            '-last_modified').first()
        health_category = determine_health_category(monthly_health_score)

        if not latest_intervention or latest_intervention.status != 'resolved':
            if health_category in ['Optimal Health', 'Good Health']:
                intervention_status = 'none'
                intervention_plan = "Health is optimal or good, no intervention required."
            else:
                intervention_status = 'unresolved'
                intervention_plan = "Immediate intervention required due to poor health status."

            latest_intervention, created = HealthIntervention.objects.update_or_create(
                orphan=orphan,
                defaults={
                    'status': intervention_status,
                    'description': intervention_plan,
                    'last_modified': now()
                }
            )
        else:
            intervention_status = latest_intervention.status
            intervention_plan = latest_intervention.description

        status_color = health_status_colors.get(health_category, 'info')
        intervention_color = intervention_status_colors.get(
            intervention_status, 'info')

        orphans_with_health.append({
            'orphan': orphan,
            'health_score': monthly_health_score,
            'health_category': health_category,
            'status_color': status_color,
            'last_modified': latest_intervention.last_modified,
            'intervention_status': intervention_status,
            'intervention_color': intervention_color,
            'intervention_plan': intervention_plan,
        })

    return render(request, 'Dashboard/intervention_health.html', {'orphans_with_health': orphans_with_health})